var plainvm=function(){function a(){return u}function b(){return v}function c(){return w}function d(a){return q[a]||null}function e(){return q}function f(a){var b=[];for(var c in a)b.push(a[c]);return b}function g(){return x}function h(a){return r&&r[a]?r[a].pic:null}function i(){return s}function j(a){return/(linux|ubuntu|fedora|debian|mandriva|gentoo|red\shat)/i.test(a)?"linux":/(windows)/i.test(a)?"win":/(mac)/i.test(a)?"mac":void 0}function k(){return y}function l(a,b){void 0!==p[a]&&console.log('Module "'+a+'" already exists!'),p[a]=b}function m(a){var b=p[a];return void 0===b?(console.log('Module "'+a+'" does not exists!'),!1):"function"==typeof b.init?(b.init(A),!0):(console.log('Cannot init the module "'+a+"\" because there's not init method"),!1)}function n(a){var b=p[a],c=!1;return void 0!==b?("function"==typeof b.detach?(b.detach(),c=!0):console.log('Cannot detach "'+a+'" detach method is missing'),delete p[a],c):(console.log('Cannot remove module "'+a+"\" because it's not registered"),!1)}function o(){var a=function(a){if(a){for(var b,c,d,e,f={},g=0;g<a.length;g+=1){b=a[g][0],e=b.replace(/\./g,"-"),d=a[g][1];for(var h=0;h<d.length;h+=1)c=d[h],c.uid=c.id+"-"+e,c.endpoint=b,f[c.uid]=c}return f}},b=function(a){for(var b=[],c=0;c<a.length;c+=1)b.push(a[c][0]);return b};z.subscribe("system-startup-init",function(c){q=a(c),s=b(c),t||z.publish("ui-startup-init",f(q)),t=!0}),z.subscribe("system-update",function(b){var c=a(b);for(var d in c)q[d]=c[d];z.publish("ui-update-vms",f(c))}),z.subscribe("system-screenshot-update",function(b){var c=a(b);for(var d in c)r[d]=c[d];z.publish("ui-screenshot-update",f(r))})}var p={},q={},r={},s=[],t=!1,u=window.location.hostname,v=parseInt(window.location.port,10),w=8080,x="fresh",y=[{key:"Windows 3.1",value:"Windows31"},{key:"Windows 95",value:"Windows95"},{key:"Windows 98",value:"Windows98"},{key:"Windows ME",value:"WindowsME"},{key:"Windows NT 4",value:"WindowsNT4"},{key:"Windows 2000",value:"Windows2000"},{key:"Windows XP",value:"WindowsXP"},{key:"Windows XP (64)",value:"WindowsXP_64"},{key:"Windows 2003",value:"Windows2003"},{key:"Windows 2003 (64 bit)",value:"Windows2003_64"},{key:"Windows Vista",value:"WindowsVista"},{key:"Windows Vista (64 bit)",value:"WindowsVista_64"},{key:"Windows 2008",value:"Windows2008"},{key:"Windows 2008 (64 bit)",value:"Windows2008_64"},{key:"Windows 7",value:"Windows7"},{key:"Windows 7 (64 bit)",value:"Windows7_64"},{key:"Windows 8",value:"Windows8"},{key:"Windows 8 (64 bit)",value:"Windows8_64"},{key:"Linux 2.2",value:"Linux22"},{key:"Linux 2.4",value:"Linux24"},{key:"Linux 2.4 (64 bit)",value:"Linux24_64"},{key:"Linux 2.6",value:"Linux26"},{key:"Linux 2.6 (64 bit)",value:"Linux26_64"},{key:"Arch Linux",value:"ArchLinux"},{key:"Arch Linux (64 bit)",value:"ArchLinux_64"},{key:"Debian",value:"Debian"},{key:"Debian (64 bit)",value:"Debian_64"},{key:"openSUSE",value:"OpenSUSE"},{key:"openSUSE (64 bit)",value:"OpenSUSE_64"},{key:"Fedora",value:"Fedora"},{key:"Fedora (64 bit)",value:"Fedora_64"},{key:"Gentoo",value:"Gentoo"},{key:"Gentoo (64 bit)",value:"Gentoo_64"},{key:"Mandriva",value:"Mandriva"},{key:"Mandriva (64 bit)",value:"Mandriva_64"},{key:"Red Hat",value:"RedHat"},{key:"Red Hat (64 bit)",value:"RedHat_64"},{key:"Turbolinux",value:"Turbolinux"},{key:"Turbolinux (64 bit)",value:"Turbolinux_64"},{key:"Ubuntu",value:"Ubuntu"},{key:"Ubuntu (64 bit)",value:"Ubuntu_64"},{key:"Xandros",value:"Xandros"},{key:"Xandros (64 bit)",value:"Xandros_64"},{key:"Oracle",value:"Oracle"},{key:"Oracle (64 bit)",value:"Oracle_64"},{key:"Mac OS X",value:"MacOS"},{key:"Mac OS X (x64)",value:"MacOS"},{key:"Other Linux",value:"OtherLinux"}],z=function(){function a(a,b){var d=c[a];void 0===d&&(d=[]),d.push(b),c[a]=d}function b(a,b){var d=c[a];if(void 0!==d){for(var e=0;e<d.length;e+=1)d[e].call(null,b);return!0}return console.log("No subscribtions for "+a),!1}var c={};return{publish:b,subscribe:a}}(),A=z;return A.getVMServer=a,A.getVMServerPort=b,A.getVmByUid=d,A.getVms=e,A.getTheme=g,A.getVMOs=j,A.getVmsArray=f,A.getScreenshotById=h,A.getRemotingPort=c,A.getOperatingSystems=k,A.getEndPoints=i,{init:o,register:l,start:m,unregister:n}}();plainvm.init(),plainvm.register("ui.preloader",function(){function a(a){$.isReady||$(document).ready(function(){b()}),a.subscribe("system-loading-completed",function(){c()})}function b(){$(document.body).append(d),d.empty(),d.append(e),e.css("left",(d.width()-e.width())/2),e.css("top",(d.height()-e.height())/2)}function c(){d.fadeOut(300,function(){d.remove()})}var d=$('<div class="plainvm-preloader"></div>'),e=$('<span class="plainvm-preloader-label"><div class="plainvm-preloader-icon"></div>Loading...</span>');return{init:a,hide:c,show:b}}()),plainvm.register("system.connection_handler",function(){function a(a){g=a,b(),g.subscribe("system-send-command",function(a){c(a)?e(a):console.log("Invalid command "+a)})}function b(){var a=h+g.getVMServer()+":"+g.getVMServerPort();f=new WebSocket(a),console.log("Connecting to "+a),d()}function c(a){try{a=JSON.parse(a)}catch(b){return!1}return a&&a.type?!0:!1}function d(){f.onconnect=function(){console.log("Connection established!")},f.onmessage=function(a){var b=JSON.parse(a.data);g.publish("system-frame-received",b),console.log("Message received")},f.onerror=function(a){console.log("Error occured in the connection-handler."),console.log(a)},f.onclose=function(){setTimeout(function(){b()},500),console.log("Connection closed!")}}function e(a){return f.send(a)}var f,g,h="ws://";return{init:a}}()),plainvm.register("ui.vms_list",function(){function a(a){n=$("#vms-list-template").html(),p=$("#plainvm-vms"),m=a,e(),d(),b()}function b(){$(".plainvm-vms").on("click",".plainvm-vm-item",function(){j(this.id)}),$(".plainvm-vms").on("mouseenter",".plainvm-vm-item",function(){this.id!==o&&$(this).addClass("plainvm-vm-item-hover")}),$(".plainvm-vms").on("mouseleave",".plainvm-vm-item",function(){$(this).removeClass("plainvm-vm-item-hover")}),$(document).on("keydown",function(a){var b,d=!1,e=a.keyCode;38===e?(b=c($("#"+o).prev()),d=!0):40===e&&(b=c($("#"+o).next()),d=!0),void 0!==b&&j(b),d&&a.preventDefault()})}function c(a){return a.is(".plainvm-vm-item")?a.attr("id"):void 0}function d(){m.subscribe("ui-startup-init",function(a){a&&(a.sort(function(a,b){return a.endpoint>b.endpoint?1:a.endpoint<b.endpoint?-1:0}),k(a),j(a[0].uid),i(),m.publish("system-loading-completed"))}),m.subscribe("ui-update-vms",function(a){a=a||[];for(var b=0;b<a.length;b+=1){var c=$(l(a[b])),d="#"+a[b].uid,e=$(d);e[0]?(c.insertBefore(e),e.remove(),h(d),o===a[b].uid&&j(a[b].uid)):c.insertAfter($(".plainvm-vm-item").last())}})}function e(){$(".plainvm-vms").on("click",".plainvm-vm-menu-icon",function(a){var b,c=$(this).data("type"),d=this.parentNode.parentNode.id,e={};if(!f(d,this.className)){if("menu"===c)m.publish("ui-show-menu-clicked",d);else{switch(b=m.getVmByUid(d),e.vm=b.id,e.endpoint=b.endpoint,c){case"start":e.action="start";break;case"poweroff":e.action="poweroff";break;case"shutdown":e.action="shutdown";break;default:console.log("Unknown VM operation")}m.publish("system-send-frame",{type:"change-vm-state",data:e})}a.stopImmediatePropagation()}}),$(".plainvm-vms").on("mousedown",".plainvm-vm-menu-icon",function(){var a=this.parentNode.parentNode.id;f(a,this.className)?$(this).addClass("plainvm-vm-menu-icon-mousedown-disabled"):$(this).addClass("plainvm-vm-menu-icon-mousedown")}),$(document.body).bind("mouseup",function(){$(".plainvm-vm-menu-icon").removeClass("plainvm-vm-menu-icon-mousedown"),$(".plainvm-vm-menu-icon").removeClass("plainvm-vm-menu-icon-mousedown-disabled")}),$(".plainvm-vms").on("mouseenter",".plainvm-vm-menu-icon",function(){$(this).addClass("plainvm-vm-menu-icon-hover")}),$(".plainvm-vms").on("mouseleave",".plainvm-vm-menu-icon",function(){$(this).removeClass("plainvm-vm-menu-icon-hover")})}function f(a,b){var c=m.getVmByUid(a).is_running;return c&&(b.indexOf("plainvm-vm-menu-icon-menu")>=0||b.indexOf("plainvm-vm-menu-icon-start")>=0)||!c&&(b.indexOf("plainvm-vm-menu-icon-poweroff")>=0||b.indexOf("plainvm-vm-menu-icon-shutdown")>=0)}function g(a){var b=m.getTheme();a=a||"",$(a+".plainvm-vm-menu-icon-menu").jqxTooltip({content:"Menu",position:"mouse",theme:b}),$(a+".plainvm-vm-menu-icon-start").jqxTooltip({content:"Start",position:"mouse",theme:b}),$(a+".plainvm-vm-menu-icon-shutdown").jqxTooltip({content:"Shutdown",position:"mouse",theme:b}),$(a+".plainvm-vm-menu-icon-poweroff").jqxTooltip({content:"Poweroff",position:"mouse",theme:b})}function h(a){a&&g(a+" ")}function i(){g()}function j(a){$(".plainvm-vm-item").removeClass("plainvm-vm-item-selected"),$("#"+a).addClass("plainvm-vm-item-selected"),m.publish("ui-vm-selected",a),o=a}function k(a){for(var b="",c=0;c<a.length;c+=1)b+=l(a[c]);p.html(b)}function l(a){var b={};$.extend(b,a),b.abr=m.getVMOs(b.os);var c=Mustache.to_html(n,b);return c}var m,n,o,p;return{init:a}}()),plainvm.register("ui.vm_details",function(){function a(a){c=$("#vm-details-template").html(),e=a,d=$("#plainvm-vm-state"),e.subscribe("ui-vm-selected",function(a){b(a)})}function b(a){var b=e.getVmByUid(a);d.html(Mustache.to_html(c,b))}var c,d,e;return{init:a}}()),plainvm.register("ui.vm_status_pic",function(){function a(a){e=a,g=$("#plainvm-machine-screenshot"),b(),c()}function b(){e.subscribe("ui-vm-selected",function(a){f=a,d()}),e.subscribe("ui-screenshot-update",function(a){a&&d()})}function c(){}function d(){var a=e.getScreenshotById(f);a?(g.css("background-image","url("+a+")"),i||(g.jqxTooltip({content:"Click to control the machine",position:"mouse",theme:e.getTheme()}),i=!0)):((!g[0].style.backgroundImage||g[0].style.backgroundImage.indexOf(h)<0)&&g.css("background-image","url("+h+")"),i&&(g.jqxTooltip("destroy"),i=!1))}var e,f,g,h="css/images/not-running.png",i=!1;return{init:a}}()),plainvm.register("ui.vm_settings",function(){function a(a){j=$("#vm-edit-template").html(),g=a,g.subscribe("ui-show-menu-clicked",function(a){b(a)})}function b(a){i=g.getVmByUid(a),i.is_running||(d(),c())}function c(){h=$("#plainvm-edit-vm-form"),h.jqxValidator({rules:[{input:"#machine-name",message:"Invalid name",action:"keyup, keydown",rule:function(a){return/^[a-zA-Z]{2,}[\sa-zA-Z0-9._\-]{1,}$/.test(a.val())}}]})}function d(){var a=$(Mustache.to_html(j,i)),b=g.getTheme();a.jqxWindow({theme:b,isModal:!0,width:400,height:300,animationType:"fade",draggable:!1,resizable:!1,autoOpen:!1,showCloseButton:!1}),a.jqxWindow("open"),a.bind("closed",function(){a.remove()}),$("#cpu-slider").jqxSlider({value:parseInt(i.cpu,10),min:1,max:100,width:150,showTicks:!1,mode:"fixed",theme:b}),$("#ram-slider").jqxSlider({value:parseInt(i.ram,10),min:1,max:4096,width:150,showTicks:!1,mode:"fixed",theme:b}),$("#video-slider").jqxSlider({value:parseInt(i.vram,10),min:1,max:128,width:150,showTicks:!1,mode:"fixed",theme:b}),$("#port-input").jqxNumberInput({decimal:parseInt(i.remote_port,10)||0,max:65535,min:200,width:150,inputMode:"simple",spinButtons:!0,decimalDigits:0,spinMode:"advance",theme:b,height:"25px"}),$("#remoting-checkbox").jqxCheckBox({checked:!!i.remoting_enabled,theme:b}),$("#save-changes").jqxButton({theme:b,width:60}),$("#cancel-changes").jqxButton({theme:b,width:60}),$("#cancel-changes").click(function(){a.jqxWindow("close")}),$("#save-changes").click(function(){e()&&(f(),a.jqxWindow("close"))})}function e(){return h&&h[0]&&h.jqxValidator("validate")}function f(){i.cpu=$("#cpu-slider").jqxSlider("value"),i.ram=$("#ram-slider").jqxSlider("value"),i.remote_port=parseInt($("#port-input").jqxNumberInput("decimal"),10),i.remote_address=g.getVmByUid(i.uid).endpoint,i.remoting_enabled=$("#remoting-checkbox").jqxCheckBox("checked"),i.name=$("#machine-name").val(),i.vram=$("#video-slider").jqxSlider("value"),g.publish("ui-update-vms",[i]),g.publish("system-send-frame",{type:"machine-edited",data:i})}var g,h,i,j;return{init:a}}()),plainvm.register("ui.vm_control",function(){function a(a){k=a,i=$("#vm-remoting-template").html(),b(),j=[]}function b(){$("#plainvm-machine-screenshot").click(function(){h.is_running&&j.push(setTimeout(function(){c(function(){d()})},400))}),$("#plainvm-machine-screenshot").dblclick(function(){if(h.is_running){for(;j.length;)clearTimeout(j.pop());c(function(){window.open(g(),"fullscreen=yes")})}}),k.subscribe("ui-vm-selected",function(a){h=k.getVmByUid(a)})}function c(a){var b=$("<iframe/>");b.css("visibility","hidden"),$(document.body).append(b),b.load(function(){"function"==typeof a&&a(),$(b).remove()}),b.attr("src",f())}function d(){if(h&&h.is_running){var a=$(Mustache.to_html(i,e(h)));$(document.body).append(a),a.jqxWindow({width:810,height:640,maxWidth:900,maxHeight:700,autoOpen:!1,isModal:!0,animationType:"fade",showAnimationDuration:1e3,hideAnimationDuration:500,modalOpacity:.9,resizable:!1,draggable:!1}),a.jqxWindow("open"),a.find("iframe").focus(),a.bind("closed",function(){a.find("iframe"),a.remove()})}}function e(a){var b={};return $.extend(b,a),b.remotingUrl=g(),b}function f(){return"http://"+h.endpoint+":"+k.getRemotingPort()+"/guacamole/logout"}function g(){return"http://"+h.endpoint+":"+k.getRemotingPort()+"/guacamole/index.xhtml?autologin=1&username="+h.id}var h,i,j,k;return{init:a}}()),plainvm.register("system.remote_command_bridge",function(){function a(a){c=a,c.subscribe("system-frame-received",function(a){c.publish(a.type,a.data)}),c.subscribe("system-send-frame",function(a){b(a.type,a.data,a.needResponse)}),c.subscribe("system-create-vm",function(a){b(a.type,a.data,a.needResponse)})}function b(a,b,d){var e={};e.type=a,b&&(e.data=b),d&&(e["need-response"]=!0),c.publish("system-send-command",JSON.stringify(e))}var c;return{init:a}}()),plainvm.register("ui.vm_statistics",function(){function a(a){k=a,k.subscribe("system-loading-completed",function(){j=$("#plainvm-vm-statistics")}),k.subscribe("ui-statistics-opened",function(){i(),b()})}function b(){n.push(c()),n.push(d()),n.push(e())}function c(){var a=k.getVms(),b=$('<div class="plainvm-chart" style="float: right;" id="plainvm-os-chart"></div>');return b.width(j.width()*l),b.height(j.width()*l),b.appendTo(j),b.jqxChart({title:"Operating systems",enableAnimations:!0,showLegend:!0,source:g(a),colorScheme:"scheme05",seriesGroups:[{type:"pie",showLabels:!1,series:[{dataField:"count",displayText:"os",initialAngle:15,radius:j.width()*m,centerOffset:0}]}]}),b}function d(){for(var a=k.getVms(),b=$('<div class="plainvm-chart" style="float: right;" id="plainvm-ram-chart"></div>'),c=h(a),d=0,e=0;e<c.length;e+=1)d<c[e].ram&&(d=c[e].ram);return b.width(j.width()*l),b.height(j.width()*l),b.appendTo(j),b.jqxChart({title:"RAM usage",enableAnimations:!0,showLegend:!0,source:c,colorScheme:"scheme05",categoryAxis:{dataField:"name",showGridLines:!0,flip:!1},seriesGroups:[{type:"column",orientation:"horizontal",valueAxis:{flip:!0,unitInterval:Math.round(d/10),maxValue:d,displayValueAxis:!0,description:""},series:[{dataField:"ram",displayText:"RAM usage",formatFunction:function(a){return a+" MB"}}]}]}),b}function e(){for(var a=k.getVms(),b=$('<div class="plainvm-chart" style="float: right;" id="plainvm-vram-chart"></div>'),c=f(a),d=0,e=0;e<c.length;e+=1)d<c[e].vram&&(d=c[e].vram);return b.width(j.width()*l),b.height(j.width()*l),b.appendTo(j),b.jqxChart({title:"Video memory",enableAnimations:!0,showLegend:!0,source:c,colorScheme:"scheme05",categoryAxis:{dataField:"name",showGridLines:!0,flip:!1},seriesGroups:[{type:"column",orientation:"horizontal",valueAxis:{flip:!0,unitInterval:Math.round(d/5),maxValue:d,displayValueAxis:!0,description:""},series:[{dataField:"vram",displayText:"VRAM usage",formatFunction:function(a){return a+" MB"}}]}]}),b}function f(a){var b,c=[];for(var d in a)b=a[d],c.push({name:b.name,vram:parseInt(b.vram,10)});return c}function g(a){var b,c,d=[],e={};for(var f in a)c=a[f],b=k.getVMOs(c.os),e[b]?e[b]+=1:e[b]=1;for(var g in e)d.push({os:g,count:e[g]});return d}function h(a){var b,c=[];for(var d in a)b=a[d],c.push({name:b.name,ram:parseInt(b.ram,10)});return c}function i(){for(var a=0;a<n.length;a+=1)n[a].jqxChart("destroy"),n[a].remove();n=[]}var j,k,l=.305,m=.1,n=[];return{init:a}}()),plainvm.register("layout.main_content_structure",function(){function a(a){b=a,$(window).load(function(){c=$("#plainvm-tabs"),c.jqxTabs({keyboardNavigation:!1,theme:b.getTheme()}),c.bind("selected",function(a){switch(a.args.item){case 0:b.publish("ui-home-opened");break;case 1:b.publish("ui-statistics-opened");break;case 2:b.publish("ui-installation-wizard-opened");break;default:console.log("Unknown tab section")}})})}var b,c;return{init:a}}()),plainvm.register("layout.install_wizard",function(){function a(){$("#plainvm-install-wizard-vm-os").jqxDropDownList({theme:e.getTheme(),source:e.getOperatingSystems(),valueMember:"value",displayMember:"key",width:280,height:25,selectedIndex:0}),$("#plainvm-install-wizard-first-next").jqxButton({theme:e.getTheme(),width:60,height:30}),$("#plainvm-install-wizard-endpoint").jqxDropDownList({theme:e.getTheme(),source:[],width:280,height:25,selectedIndex:0})}function b(){$("#plainvm-install-wizard-ram-slider").jqxSlider({min:50,max:2048,value:256,step:50,ticksFrequency:100,mode:"fixed",width:280,theme:e.getTheme()}),$("#plainvm-install-wizard-hdd-slider").jqxSlider({min:2e3,max:5e4,step:500,value:1e4,ticksFrequency:2e3,mode:"fixed",width:280,theme:e.getTheme()}),$("#plainvm-install-wizard-second-next").jqxButton({theme:e.getTheme(),width:60,height:30}),$("#plainvm-install-wizard-second-back").jqxButton({theme:e.getTheme(),width:60,height:30})}function c(){$("#plainvm-install-wizard-finish").jqxButton({theme:e.getTheme(),width:60,height:30}),$("#plainvm-install-wizard-third-back").jqxButton({theme:e.getTheme(),width:60,height:30}),$("#plainvm-install-wizard-progress").jqxProgressBar({height:25,width:280,min:0,max:100,value:0,animationDuration:0,theme:e.getTheme()})}function d(d){e=d,$(window).load(function(){f=$("#plainvm-vm-installation"),f.jqxTabs({keyboardNavigation:!1,theme:e.getTheme(),width:"600",height:"400",enabledHover:!1,disabled:!0}),f.bind("selected",function(a){if(1===a.args.item){var b=$("#plainvm-install-wizard-ram-slider"),c=$("#plainvm-install-wizard-hdd-slider");b.jqxSlider("value",b.jqxSlider("value")),c.jqxSlider("value",c.jqxSlider("value"))}return!1}),a(),b(),c()}),e.subscribe("ui-startup-init",function(){$("#plainvm-install-wizard-endpoint").jqxDropDownList("source",e.getEndPoints())})}var e,f;return{init:d}}()),plainvm.register("ui.install_wizard",function(){function a(a){i=a,h=$("#plainvm-vm-installation"),g(0),i.subscribe("system-loading-completed",function(){c(),d(),e()}),i.subscribe("system-install-finished",function(){var a=$("#plainvm-install-wizard-finish");a.jqxButton("disabled",!1),a.text("Reset"),a.bind("click",b),a.unbind("click",f)}),i.subscribe("system-install-info",function(a){$("#plainvm-install-wizard-info").text(a)}),h.bind("selected",function(){$("#plainvm-vm-install-wizard-section-1").jqxValidator("hide"),$("#plainvm-vm-install-wizard-section-2").jqxValidator("hide"),$("#plainvm-vm-install-wizard-section-3").jqxValidator("hide")})}function b(){var a=$("#plainvm-install-wizard-finish");h.jqxTabs("enableAt",0),h.jqxTabs("disableAt",2),h.jqxTabs("selectedItem",0),h.find("input").val(""),$("#plainvm-install-wizard-ram-slider").jqxSlider("value",256),$("#plainvm-install-wizard-hdd-slider").jqxSlider("value",1e4),$("#plainvm-install-wizard-progress").jqxProgressBar("value",0),$("#plainvm-install-wizard-info").text(""),a.text("Create"),a.unbind("click",b),a.bind("click",f)}function c(){var a=$("#plainvm-vm-install-wizard-section-1").jqxValidator();a.jqxValidator({rules:[{input:"#plainvm-install-wizard-vm-name",message:"Invalid name.",action:"keyup,blur",rule:function(a){return/^[a-zA-Z]{2,}[\sa-zA-Z0-9._\-]{1,}$/.test(a.val())}}]}),$("#plainvm-install-wizard-first-next").bind("click",function(){a.jqxValidator("validate")&&(i.publish("ui-install-wizard-first-section",{name:$("#plainvm-install-wizard-vm-name").val(),os:$("#plainvm-install-wizard-vm-os").jqxDropDownList("getSelectedItem").value,endpoint:$("#plainvm-install-wizard-endpoint").jqxDropDownList("getSelectedItem").value}),g(1))})}function d(){var a=$("#plainvm-vm-install-wizard-section-2").jqxValidator();a.jqxValidator({rules:[{input:"#plainvm-install-wizard-file",message:"The ISO file is required",rule:function(a){return!!a.val().length}}]}),$("#plainvm-install-wizard-second-next").bind("click",function(){a.jqxValidator("validate")&&(i.publish("ui-install-wizard-second-section",{ram:$("#plainvm-install-wizard-ram-slider").jqxSlider("value"),hdds:$("#plainvm-install-wizard-hdd-slider").jqxSlider("value"),file:document.getElementById("plainvm-install-wizard-file").files[0]}),g(2))}),$("#plainvm-install-wizard-second-back").bind("click",function(){g(0)})}function e(){var a=$("#plainvm-install-wizard-progress");$("#plainvm-install-wizard-finish").bind("click",f),$("#plainvm-install-wizard-third-back").bind("click",function(){g(1)}),i.subscribe("system-vm-install-progress",function(b){a.jqxProgressBar("value",b)})}function f(){$("#plainvm-install-wizard-finish").jqxButton("disabled",!0),$("#plainvm-install-wizard-third-back").jqxButton("disabled",!0),i.publish("ui-install-wizard-finish-section")}function g(a){h.jqxTabs("disabled",!0),h.jqxTabs("enableAt",a),h.jqxTabs("selectedItem",a)}var h,i;return{init:a}}()),plainvm.register("layout.index_side_panel_structure",function(){function a(a){b=a,$(window).load(function(){c=$("#plainvm-info-container"),c.jqxDocking({width:"100%",theme:b.getTheme(),mode:"docked"}),c.jqxDocking("hideAllCloseButtons")})}var b,c;return{init:a}}()),plainvm.register("system.install_vm",function(){function a(a){h=a,h.subscribe("ui-install-wizard-first-section",function(a){i={},$.extend(i,a)}),h.subscribe("ui-install-wizard-second-section",function(a){$.extend(i,a),console.log(i)}),h.subscribe("ui-install-wizard-finish-section",function(a){$.extend(i,a),c()}),h.subscribe("response-iso-chunk",function(a){var c,f=j[a.filename];b("Chunk #"+a.id+" is successfully saved"),clearTimeout(f.active[a.id]),c=100*f.transfer.CHUNK_SIZE*a.id/f.transfer.size,95>=c&&h.publish("system-vm-install-progress",c),f.transfer.CHUNK_SIZE*f.transfer.current>=f.transfer.size?e(a.filename):d(a.filename)}),h.subscribe("create-vm-success",function(a){var c=a.name;b(c+" was successfully created."),h.publish("system-vm-install-progress",100),h.publish("system-install-finished")}),h.subscribe("create-vm-fail",function(a){var c=a.name,d=a.cause;b("Error while creating "+c+". "+d),h.publish("system-install-finished")})}function b(a){h.publish("system-install-info",a)}function c(){var a={},b=Object.create(k);$.extend(a,i),a.filename=a.os,a.destination=a.endpoint,b.init(a,g),j[a.os]={transfer:b,active:[]},d(a.os)}function d(a){var c=j[a].transfer;c.nextChunk(function(){var e=c.current;j[a].active[e]=setTimeout(function(){b("Chunk #"+e+" timeouted. Retrying..."),c.current=e,d(a)},4e3)})}function e(a){b("Transfer finished. Creation of the VM started Virtual Machine");var c=j[a].active;for(var d in c)clearTimeout(c[d]);delete j[a],f()}function f(){h.publish("system-create-vm",{type:"system-create-vm",data:{hdds:i.hdds,ram:i.ram,name:i.name,os:i.os,endpoint:i.endpoint},needResponse:!0})}function g(a){var c={chunk:a.data,filename:a.filename,id:a.id,endpoint:a.destination,force:!0,"need-response":!0};h.publish("system-send-frame",{type:"system-iso-chunk",data:c,needResponse:!0}),b("Sending chunk #"+a.id+".")}var h,i,j=[],k={CHUNK_SIZE:10008,file:void 0,size:void 0,destination:void 0,current:0,init:function(a,b){this.file=a.file,this.filename=a.filename,this.size=a.file.size,this.destination=a.destination,this.current=0,this.sendChunk=this.sendChunk||b},nextChunk:function(a){var b=this.current*this.CHUNK_SIZE,c=b+this.CHUNK_SIZE;if(this.size<b)return-1;var d=this.file.slice(b,c),e=this,f=new FileReader;return f.onload=function(b){e._chunkLoaded(b,a)},f.readAsDataURL(d),this.current},_chunkLoaded:function(a,b){var c=a.target.result;g({data:c.substr(13,c.length),filename:this.filename,id:this.current,destination:this.destination}),"function"==typeof b&&b(),this.current+=1},sendChunk:function(){console.log("Sending...")}};return{init:a}}()),plainvm.start("ui.preloader"),$(window).load(function(){plainvm.start("ui.vm_statistics"),plainvm.start("system.remote_command_bridge"),plainvm.start("ui.vm_status_pic"),plainvm.start("ui.vms_list"),plainvm.start("ui.vm_control"),plainvm.start("ui.vm_details"),plainvm.start("ui.vm_settings"),plainvm.start("ui.install_wizard"),plainvm.start("system.connection_handler"),plainvm.start("system.install_vm")}),plainvm.start("layout.index_side_panel_structure"),plainvm.start("layout.main_content_structure"),plainvm.start("layout.install_wizard");